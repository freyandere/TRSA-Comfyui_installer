#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ComfyUI Accelerator v4.0 - Simple & Fixed Installation
–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π
"""
import subprocess
import urllib.request
import zipfile
import sys
import os
import locale
from pathlib import Path
from typing import Tuple, Dict

class SimpleInstaller:
    """–ü—Ä–æ—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ ComfyUI Accelerator"""
    
    def __init__(self):
        self.python_exe = self._find_python()
        self.language = self._detect_language()
        self.messages = self._load_messages()
        
    def _find_python(self) -> str:
        """–ü–æ–∏—Å–∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ Python"""
        for exe in ["python.exe", "python"]:
            if os.path.exists(exe):
                return exe
        raise FileNotFoundError("Python executable not found")
    
    def _detect_language(self) -> str:
        """–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å —Å–∏—Å—Ç–µ–º—ã
            system_locale = locale.getdefaultlocale()[0]
            if system_locale and system_locale.startswith('ru'):
                return 'ru'
        except:
            pass
        return 'en'
    
    def _load_messages(self) -> Dict[str, Dict[str, str]]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–≤—É—Ö —è–∑—ã–∫–æ–≤"""
        return {
            'ru': {
                'header': 'üöÄ ComfyUI Accelerator - –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞',
                'lang_choice': '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose language: 1-English, 2-–†—É—Å—Å–∫–∏–π: ',
                'checking_python': '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python',
                'upgrading_pip': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip',
                'installing_triton': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Triton',
                'installing_sage': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SageAttention',
                'setting_up_libs': '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ include/libs',
                'success': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!',
                'restart_note': 'üí° –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ ComfyUI –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É—Å–∫–æ—Ä–µ–Ω–∏—è',
                'some_failed': '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å',
                'press_enter': '–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...'
            },
            'en': {
                'header': 'üöÄ ComfyUI Accelerator - Simple Installation',
                'lang_choice': 'Choose language / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫: 1-English, 2-–†—É—Å—Å–∫–∏–π: ',
                'checking_python': 'Checking Python version',
                'upgrading_pip': 'Upgrading pip',
                'installing_triton': 'Installing Triton',
                'installing_sage': 'Installing SageAttention',
                'setting_up_libs': 'Setting up include/libs',
                'success': 'Installation completed successfully!',
                'restart_note': 'üí° Restart ComfyUI to apply 2-3x speed improvements',
                'some_failed': 'Some components failed to install',
                'press_enter': 'Press Enter to exit...'
            }
        }
    
    def msg(self, key: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–µ–∫—É—â–µ–º —è–∑—ã–∫–µ"""
        return self.messages[self.language].get(key, key)
    
    def _run_command(self, cmd: list, timeout: int = 300) -> Tuple[bool, str]:
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        try:
            result = subprocess.run(
                cmd, capture_output=True, text=True, timeout=timeout, encoding='utf-8'
            )
            return result.returncode == 0, result.stdout + result.stderr
        except Exception as e:
            return False, str(e)
    
    def _download_file(self, url: str, filename: str) -> bool:
        """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        try:
            urllib.request.urlretrieve(url, filename)
            return os.path.exists(filename) and os.path.getsize(filename) > 1000
        except Exception:
            return False
    
    def check_python_version(self) -> Tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)"""
        success, output = self._run_command([
            self.python_exe, "-c", 
            "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')"
        ])
        
        if success:
            try:
                version = float(output.strip())
                # –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢—Ä–µ–±—É–µ—Ç—Å—è Python 3.12+, –∞ –Ω–µ 3.9+
                if version >= 3.12:
                    return True, f"Python {version} - OK"
                return False, f"Python {version} too old (need 3.12+)"
            except ValueError:
                return False, f"Cannot parse Python version: {output}"
        return False, "Cannot detect Python version"
    
    def upgrade_pip(self) -> Tuple[bool, str]:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏"""
        success, output = self._run_command([
            self.python_exe, "-m", "pip", "install", "--upgrade", "pip"
        ])
        return success, "pip upgraded successfully" if success else f"pip upgrade failed: {output}"
    
    def install_triton(self) -> Tuple[bool, str]:
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Triton Windows"""
        success, output = self._run_command([
            self.python_exe, "-m", "pip", "install", "-U", "triton-windows<3.4"
        ])
        return success, "Triton installed" if success else f"Triton failed: {output[:200]}"
    
    def install_sageattention(self) -> Tuple[bool, str]:
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ SageAttention (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞)"""
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è wheel —Ñ–∞–π–ª–∞
        wheel_url = "https://github.com/freyandere/TRSA-Comfyui_installer/raw/main/sageattention-2.2.0%2Bcu128torch2.7.1.post1-cp39-abi3-win_amd64.whl"
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: –õ–æ–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å URL
        wheel_file = "sageattention-2.2.0+cu128torch2.7.1.post1-cp39-abi3-win_amd64.whl"
        
        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ wheel
        if not self._download_file(wheel_url, wheel_file):
            return False, "Failed to download SageAttention wheel"
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ wheel
        success, output = self._run_command([
            self.python_exe, "-m", "pip", "install", wheel_file
        ])
        
        # –û—á–∏—Å—Ç–∫–∞
        try:
            os.remove(wheel_file)
        except:
            pass
            
        return success, "SageAttention installed" if success else f"SageAttention failed: {output[:200]}"
    
    def setup_include_libs(self) -> Tuple[bool, str]:
        """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø–∞–ø–æ–∫ include/libs"""
        if os.path.exists("include") and os.path.exists("libs"):
            return True, "include/libs folders already exist"
        
        zip_url = "https://github.com/freyandere/TRSA-Comfyui_installer/raw/main/python_3.12.7_include_libs.zip"
        zip_file = "include_libs.zip"
        
        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
        if not self._download_file(zip_url, zip_file):
            return False, "Failed to download include/libs archive"
        
        # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
        try:
            with zipfile.ZipFile(zip_file, 'r') as zip_ref:
                zip_ref.extractall('.')
            os.remove(zip_file)
            
            if os.path.exists("include") and os.path.exists("libs"):
                return True, "include/libs folders created"
            return False, "Extraction completed but folders not found"
            
        except Exception as e:
            return False, f"Extraction failed: {str(e)}"
    
    def choose_language(self):
        """–í—ã–±–æ—Ä —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
        print(self.msg('lang_choice'), end='')
        try:
            choice = input().strip()
            if choice == '1':
                self.language = 'en'
            elif choice == '2':
                self.language = 'ru'
        except:
            pass  # –û—Å—Ç–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —è–∑—ã–∫
    
    def run_installation(self) -> bool:
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        # –í—ã–±–æ—Ä —è–∑—ã–∫–∞
        self.choose_language()
        
        steps = [
            (self.msg('checking_python'), self.check_python_version),
            (self.msg('upgrading_pip'), self.upgrade_pip),
            (self.msg('installing_triton'), self.install_triton),
            (self.msg('installing_sage'), self.install_sageattention),
            (self.msg('setting_up_libs'), self.setup_include_libs)
        ]
        
        print(self.msg('header'))
        print("=" * 50)
        
        all_success = True
        for i, (description, method) in enumerate(steps, 1):
            print(f"\n{i}/{len(steps)} {description}...")
            success, message = method()
            
            if success:
                print(f"‚úÖ {message}")
            else:
                print(f"‚ùå {message}")
                all_success = False
        
        print("\n" + "=" * 50)
        if all_success:
            print(f"üéâ {self.msg('success')}")
            print(self.msg('restart_note'))
        else:
            print(f"‚ö†Ô∏è {self.msg('some_failed')}")
        
        return all_success


if __name__ == "__main__":
    try:
        installer = SimpleInstaller()
        installer.run_installation()
    except KeyboardInterrupt:
        print("\nüëã Installation cancelled by user")
    except Exception as e:
        print(f"‚ùå Critical error: {e}")
    finally:
        print()
        # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —è–∑—ã–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ installer –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è
        try:
            print(installer.msg('press_enter'))
        except:
            print("Press Enter to exit... / –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
        input()
